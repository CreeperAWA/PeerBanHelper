var H=Object.defineProperty;var P=(o,e,u)=>e in o?H(o,e,{enumerable:!0,configurable:!0,writable:!0,value:u}):o[e]=u;var S=(o,e,u)=>P(o,typeof e!="symbol"?e+"":e,u);import{a as x,u as W,g as j,e as z,_ as J}from"./index-C_dGPCGo.js";import{f as M,a6 as q,r as v,a as U,a8 as K,c as Q,I as X,j as g,s as _,t as r,y as n,a2 as p,u as L,k as Y,F as Z,P as ee,v as w,x as b}from"./libs-D-uoNQCp.js";import{M as A,v as te,G as se,F as oe,b as ae,S as le,H as re,T as ne,k as ie,n as ue}from"./arcoDesign-CRyOpHTj.js";var d=(o=>(o.DEBUG="DEBUG",o.INFO="INFO",o.WARN="WARN",o.ERROR="ERROR",o.TRACE="TRACE",o))(d||{});class ce{constructor(e,u,h){S(this,"_isOpen",!1);S(this,"ws");S(this,"url");const t=new URL(e);this.url=new URL(x(`${t.protocol==="https:"?"wss":"ws"}://${t.host}${t.pathname}`,u)),this.url.searchParams.append("token",h)}get isOpen(){return this._isOpen}get State(){var e;return((e=this.ws)==null?void 0:e.readyState)??WebSocket.CLOSED}open(e,u,h){var t;try{(t=this.ws)==null||t.close(),this.url.searchParams.append("offset",e.toString()),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this._isOpen=!0},this.ws.onerror=f=>{h(new Error(`WebSocket error: ${f}`))},this.ws.onclose=()=>{this._isOpen=!1},this.ws.onmessage=f=>{try{const i=JSON.parse(f.data);i.success?u(i.data):h(new Error(`WebSocket error: ${i.message}`))}catch{}}}catch(f){return f instanceof Error&&h(f),!1}return!0}close(){var e;this._isOpen&&((e=this.ws)==null||e.close(),this.ws=void 0)}}class de extends ce{constructor(){const e=W();super(e.endpoint,"api/logs/stream",e.authToken)}}async function he(){const o=W();await o.serverAvailable;const e=new URL(x(o.endpoint,"api/logs/history"),location.href);return fetch(e,{headers:j()}).then(u=>(o.assertResponseLogin(u),u.json()))}const fe=M({__name:"logViewer",setup(o){const{t:e,d:u}=q(),h=v(!0),t=U({hideThreads:[],autoScroll:!1,autoRefresh:!1,showLevel:{[d.TRACE]:!1,[d.DEBUG]:!1,[d.INFO]:!0,[d.WARN]:!0,[d.ERROR]:!0}}),f=v([]),i=U([]);K(he,{onSuccess:l=>{i.splice(0,i.length),i.push(...l.data),h.value=!1;const a=new Set;l.data.forEach(c=>a.add(c.thread)),f.value=Array.from(a).map(c=>({value:c,tagProps:{color:N(c)}}))}});const B=Q(()=>i.filter(l=>t.showLevel[l.level]).filter(l=>!t.hideThreads.includes(l.thread))),V=v(),y=new de,C=async l=>{try{return l?y.open(i.length>0?i[i.length-1].offset:0,a=>{var c;i.push(a),t.autoScroll&&((c=V.value)==null||c.scrollIntoView({index:i.length-1,align:"bottom"}))},a=>{A.error(a.message),t.autoRefresh=!1}):(y.close(),!0)}catch(a){return a instanceof Error&&A.error(a.message),!1}},O=l=>{switch(l){case d.TRACE:return"blue";case d.WARN:return"orange";case d.ERROR:return"red";case d.DEBUG:case d.INFO:default:return"gray"}},N=l=>l.startsWith("virtual-")||l.startsWith("pool")||/Thread-[0-9]+/.test(l)?"gray":z(l,["orange","orangered","red","blue"]);X(()=>{y.close()});const T=v(!0);return(l,a)=>{const c=te,m=se,I=oe,R=ae,k=le,F=re,D=ne,G=ie,$=ue;return g(),_(k,{direction:"vertical",class:"container",size:"medium"},{default:r(()=>[n(F,{disabled:h.value,model:t,layout:"inline"},{default:r(()=>[n(m,{field:"autoRefresh",label:p(e)("page.settings.tab.info.log.enableAutoRefresh")},{default:r(()=>[n(c,{modelValue:t.autoRefresh,"onUpdate:modelValue":a[0]||(a[0]=s=>t.autoRefresh=s),"before-change":C},null,8,["modelValue"])]),_:1},8,["label"]),t.autoRefresh?(g(),_(m,{key:0,field:"autoScroll",label:p(e)("page.settings.tab.info.log.autoScorll")},{default:r(()=>[n(c,{modelValue:t.autoScroll,"onUpdate:modelValue":a[1]||(a[1]=s=>t.autoScroll=s)},null,8,["modelValue"])]),_:1},8,["label"])):L("",!0),n(m,{field:"showThreadName",label:p(e)("page.settings.tab.info.log.showThread")},{default:r(()=>[n(c,{modelValue:T.value,"onUpdate:modelValue":a[2]||(a[2]=s=>T.value=s)},null,8,["modelValue"])]),_:1},8,["label"]),n(m,{field:"hideThreads",label:p(e)("page.settings.tab.info.log.hideThreads")},{default:r(()=>[n(I,{modelValue:t.hideThreads,"onUpdate:modelValue":a[3]||(a[3]=s=>t.hideThreads=s),placeholder:p(e)("page.settings.tab.info.log.hideThreads.placeholder"),style:{width:"15rem"},multiple:"","max-tag-count":1,"allow-create":"",scrollbar:"",options:f.value,"virtual-list-props":{height:200}},null,8,["modelValue","placeholder","options"])]),_:1},8,["label"]),n(m,{field:"hideThreads",label:p(e)("page.settings.tab.info.log.showLevel")},{default:r(()=>[n(k,null,{default:r(()=>[(g(!0),Y(Z,null,ee(Object.keys(t.showLevel),s=>(g(),_(R,{key:s,checked:t.showLevel[s],"onUpdate:checked":E=>t.showLevel[s]=E,color:O(s),checkable:""},{default:r(()=>[w(b(s),1)]),_:2},1032,["checked","onUpdate:checked","color"]))),128))]),_:1})]),_:1},8,["label"])]),_:1},8,["disabled","model"]),n($,{ref_key:"logList",ref:V,size:"small",loading:h.value,scrollbar:"","virtual-list-props":{height:700,buffer:20},data:B.value},{item:r(({item:s,index:E})=>[(g(),_(G,{key:E},{default:r(()=>[n(k,{class:"log-line",fill:""},{default:r(()=>[n(R,{class:"level-tag",color:O(s.level)},{default:r(()=>[w(b(s.level),1)]),_:2},1032,["color"]),n(R,null,{default:r(()=>[w(b(p(u)(s.time,"log")),1)]),_:2},1024),T.value?(g(),_(R,{key:0,color:N(s.thread)},{default:r(()=>[w(b(s.thread),1)]),_:2},1032,["color"])):L("",!0),n(D,{ellipsis:{rows:1,showTooltip:!0}},{default:r(()=>[w(b(s.content),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))]),_:1},8,["loading","data"])]),_:1})}}}),we=J(fe,[["__scopeId","data-v-7898f704"]]);export{we as default};
